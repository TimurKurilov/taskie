<h2>Глобальный чат</h2>

<div id="chat-log" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:10px;">
  {% if messages %}
    {% for message in messages %}
      <div><strong>{{ message.user.username }}:</strong> {{ message.context }}</div>
    {% endfor %}
  {% else %}
    <p>Пока нет сообщений.</p>
  {% endif %}
</div>

<input id="chat-message-input" type="text" autocomplete="off" />
<button onclick="sendMessage()">Отправить</button>

<script>
  const chatLog = document.getElementById('chat-log');
  const taskId = "{{ id }}";

  function addMessage(username, message) {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${username}:</strong> ${message}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  const socket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + taskId + '/');

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.message && data.username) {
      addMessage(data.username, data.message);
    }
  };

  function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const message = input.value.trim();
    if (message) {
      socket.send(JSON.stringify({ message: message, task_id: taskId }));
      input.value = '';
    }
  }
</script>
