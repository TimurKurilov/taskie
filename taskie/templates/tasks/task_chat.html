<h2>Глобальный чат</h2>

<div id="chat-log" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:10px;">
  {% if messages %}
    {% for message in messages %}
      <div><strong>{{ message.user.username }}:</strong> {{ message.context }}</div>
    {% endfor %}
  {% else %}
    <p>Пока нет сообщений.</p>
  {% endif %}
</div>

<input id="chat-message-input" type="text" autocomplete="off" />
<input id="file-input" type="file" />
<button onclick="sendMessage()">Отправить</button>

<script>
  const chatLog = document.getElementById('chat-log');
  const taskId = "{{ id }}";
  const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
  const socket = new WebSocket(protocol + window.location.host + '/ws/chat/' + taskId + '/');


  function addMessage(username, message) {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${username}:</strong> ${message}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function displayUploadedFile(fileUrl, fileName, fileType, username) {
    const newMessageDiv = document.createElement('div');
    let contentHtml = '';

    if (fileType === 'image') {
      contentHtml = `<img src="${fileUrl}" alt="${fileName}" style="max-width:200px; border-radius:8px; margin-top:5px;"/>`;
    } else if (fileType === 'video') {
      contentHtml = `<video controls width="200" style="border-radius:8px; margin-top:5px;"><source src="${fileUrl}" type="video/mp4"></video>`;
    } else if (fileType === 'audio') {
      contentHtml = `<audio controls style="width:100%; margin-top:5px;"><source src="${fileUrl}" type="audio/mpeg"></audio>`;
    } else {
      contentHtml = `<p>File: <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">${fileName}</a></p>`;
    }

    newMessageDiv.innerHTML = `<strong>${username}:</strong> ${contentHtml}`;
    chatLog.appendChild(newMessageDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.message && data.username) {
      addMessage(data.username, data.message);
    }
    if (data.file_url && data.file_name && data.file_type && data.username) {
      displayUploadedFile(data.file_url, data.file_name, data.file_type, data.username);
    }
  };

  async function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('file-input');

    const message = input.value.trim();
    const file = fileInput.files[0];

    if (message) {
      socket.send(JSON.stringify({ message: message, task_id: taskId }));
      input.value = '';
    }

    if (file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('task_id', taskId);

      const response = await fetch('/upload/', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        socket.send(JSON.stringify({
          file_url: result.file_url,
          file_name: result.file_name,
          file_type: result.file_type,
          task_id: taskId
        }));
        fileInput.value = '';
      } else {
        alert('Ошибка загрузки файла!');
      }
    }
  }
</script>

