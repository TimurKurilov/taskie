{% extends "base.html" %}
{% load static %}

{% block title %}Чат{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task_chat.css' %}">
{% endblock %}

{% block content %}
<h2>Чат задачи</h2>

<div id="chat-log" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px;">
  {% if messages %}
    {% for message in messages %}
      <div>
        <strong>{{ message.user.username }}:</strong>
        {% if '/media/' in message.context %}
          {% with file_url=message.context %}
            {% if file_url|lower|slice:"-4:" == ".jpg" or file_url|lower|slice:"-5:" == ".jpeg" or file_url|lower|slice:"-4:" == ".png" or file_url|lower|slice:"-5:" == ".webp" %}
              <img src="{{ file_url }}" alt="image" style="max-width:200px;border-radius:8px;margin-top:5px;">
            {% elif file_url|lower|slice:"-4:" == ".mp4" or file_url|lower|slice:"-5:" == ".webm" %}
              <video controls width="200" style="border-radius:8px;margin-top:5px;">
                <source src="{{ file_url }}" type="video/mp4">
              </video>
            {% elif file_url|lower|slice:"-4:" == ".mp3" or file_url|lower|slice:"-4:" == ".wav" %}
              <audio controls style="width:100%;margin-top:5px;">
                <source src="{{ file_url }}" type="audio/mpeg">
              </audio>
            {% else %}
              <a href="{{ file_url }}" target="_blank">{{ file_url }}</a>
            {% endif %}
          {% endwith %}
        {% else %}
          {{ message.context }}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>Пока нет сообщений.</p>
  {% endif %}
</div>

<input id="chat-message-input" type="text" placeholder="Введите сообщение" autocomplete="off" />
<input id="file-input" type="file" />
<button onclick="sendMessage()">Отправить</button>

<script>
const chatLog = document.getElementById('chat-log');
const taskId = "{{ task_id }}";
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + '/ws/chat/' + taskId + '/');

function addMessage(username, message) {
    const div = document.createElement('div');

    if (message.startsWith('/media/')) {
        const ext = message.split('.').pop().toLowerCase();
        let content = '';

        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
            content = `<img src="${message}" style="max-width:200px;border-radius:8px;">`;
        } else if (['mp4', 'webm', 'mov'].includes(ext)) {
            content = `<video controls width="200"><source src="${message}" type="video/${ext}"></video>`;
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
            content = `<audio controls><source src="${message}" type="audio/${ext}"></audio>`;
        } else {
            content = `<a href="${message}" target="_blank">${message}</a>`;
        }

        div.innerHTML = `<strong>${username}:</strong> ${content}`;
    } else {
        div.innerHTML = `<strong>${username}:</strong> ${message}`;
    }

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

socket.onopen = () => console.log("WebSocket connected");

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.username) {
        if (data.message) {
            addMessage(data.username, data.message);
        } else if (data.file_url) {
            addMessage(data.username, data.file_url);
        }
    }
};

socket.onclose = (event) => console.log("WebSocket closed:", event.code);

async function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('file-input');
    const message = input.value.trim();
    const file = fileInput.files[0];

    if (socket.readyState !== WebSocket.OPEN) {
        alert("Соединение ещё не установлено. Попробуйте чуть позже.");
        return;
    }

    if (!message && !file) {
        return;
    }

    let fileData = {};

    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('task_id', taskId);

        try {
            const response = await fetch('/upload/', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Ошибка загрузки файла!');
            const result = await response.json();
            fileData = {
                file_url: result.file_url,
                file_name: result.file_name,
                file_type: result.file_type
            };
        } catch (err) {
            alert(err.message);
            return;
        }
    }

    socket.send(JSON.stringify({
        message: message,
        ...fileData
    }));

    input.value = '';
    fileInput.value = '';
}

window.addEventListener("beforeunload", () => {
    if (socket.readyState === WebSocket.OPEN) socket.close();
});
</script>
{% endblock %}
