{% extends "base.html" %}
{% load static %}

{% block title %}–ß–∞—Ç{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task_chat.css' %}">
{% endblock %}

{% block content %}
<h2>–ß–∞—Ç –∑–∞–¥–∞—á–∏</h2>

<div id="chat-log" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px;">
  {% if messages %}
    {% for message in messages %}
      <div>
        <strong>{{ message.user.username }}:</strong>
        {% if '/media/' in message.context %}
          {% with file_url=message.context %}
            {% if file_url|lower|slice:"-4:" == ".jpg" or file_url|lower|slice:"-5:" == ".jpeg" or file_url|lower|slice:"-4:" == ".png" or file_url|lower|slice:"-5:" == ".webp" or file_url|lower|slice:"-4:" == ".gif" or file_url|lower|slice:"-4:" == ".bmp" %}
              <img src="{{ file_url }}" alt="image" style="max-width:200px;border-radius:8px;margin-top:5px;">
            {% elif file_url|lower|slice:"-4:" == ".mp4" or file_url|lower|slice:"-5:" == ".webm" or file_url|lower|slice:"-4:" == ".avi" or file_url|lower|slice:"-4:" == ".mov" %}
              <video controls width="200" style="border-radius:8px;margin-top:5px;">
                <source src="{{ file_url }}">
              </video>
            {% elif file_url|lower|slice:"-4:" == ".mp3" or file_url|lower|slice:"-4:" == ".wav" or file_url|lower|slice:"-4:" == ".ogg" %}
              <audio controls style="width:100%;margin-top:5px;">
                <source src="{{ file_url }}">
              </audio>
            {% elif file_url|lower|slice:"-4:" == ".pdf" %}
              <a href="{{ file_url }}" target="_blank">üìÑ {{ file_url|slice:"7:" }}</a>
            {% elif file_url|lower|slice:"-5:" == ".docx" %}
              <a href="{{ file_url }}" target="_blank">üìù {{ file_url|slice:"7:" }}</a>
            {% elif file_url|lower|slice:"-5:" == ".xlsx" %}
              <a href="{{ file_url }}" target="_blank">üìä {{ file_url|slice:"7:" }}</a>
            {% elif file_url|lower|slice:"-4:" == ".zip" or file_url|lower|slice:"-4:" == ".rar" %}
              <a href="{{ file_url }}" target="_blank">üì¶ {{ file_url|slice:"7:" }}</a>
            {% else %}
              <a href="{{ file_url }}" target="_blank">{{ file_url }}</a>
            {% endif %}
          {% endwith %}
        {% else %}
          {{ message.context }}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
  {% endif %}
</div>

<input id="chat-message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off" />
<input id="file-input" type="file" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.mp4,.avi,.mov,.webm,.mp3,.wav,.ogg,.txt,.pdf,.docx,.xlsx,.zip,.rar" />
<button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<script>
const chatLog = document.getElementById('chat-log');
const taskId = "{{ task_id }}";
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + '/ws/chat/' + taskId + '/');

function addMessage(username, message) {
    const div = document.createElement('div');

    if (message.startsWith('/media/')) {
        const ext = message.split('.').pop().toLowerCase();
        let content = '';

        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
            content = `<img src="${message}" style="max-width:200px;border-radius:8px;margin-top:5px;">`;
        } else if (['mp4', 'webm', 'mov', 'avi'].includes(ext)) {
            content = `<video controls width="200" style="border-radius:8px;margin-top:5px;"><source src="${message}"></video>`;
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
            content = `<audio controls style="width:100%;margin-top:5px;"><source src="${message}"></audio>`;
        } else if (ext === 'pdf') {
            content = `<a href="${message}" target="_blank">üìÑ ${message.split('/').pop()}</a>`;
        } else if (ext === 'docx') {
            content = `<a href="${message}" target="_blank">üìù ${message.split('/').pop()}</a>`;
        } else if (ext === 'xlsx') {
            content = `<a href="${message}" target="_blank">üìä ${message.split('/').pop()}</a>`;
        } else if (['zip', 'rar'].includes(ext)) {
            content = `<a href="${message}" target="_blank">üì¶ ${message.split('/').pop()}</a>`;
        } else if (ext === 'txt') {
            content = `<a href="${message}" target="_blank">üìÉ ${message.split('/').pop()}</a>`;
        } else {
            content = `<a href="${message}" target="_blank">${message.split('/').pop()}</a>`;
        }

        div.innerHTML = `<strong>${username}:</strong> ${content}`;
    } else {
        div.innerHTML = `<strong>${username}:</strong> ${message}`;
    }

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

socket.onopen = () => {
    console.log("WebSocket connected");
};

socket.onmessage = function(e) {
    try {
        const data = JSON.parse(e.data);
        
        if (!data.username) {
            console.warn('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ username:', data);
            return;
        }
        if (data.message) {
            addMessage(data.username, data.message);
        } else if (data.file_url) {
            addMessage(data.username, data.file_url);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', error);
        console.error('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', e.data);
    }
};

socket.onerror = function(error) {
    console.error('WebSocket error:', error);
};

socket.onclose = function(event) {
    console.log("WebSocket closed:", event.code, event.reason);
    if (event.code !== 1000) {
        console.error('WebSocket –∑–∞–∫—Ä—ã—Ç —Å –æ—à–∏–±–∫–æ–π');
    }
};
async function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('file-input');
    const message = input.value.trim();
    const file = fileInput.files[0];
    if (socket.readyState !== WebSocket.OPEN) {
        alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.");
        return;
    }
    if (!message && !file) {
        return;
    }
    const payload = {};

    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('task_id', taskId);

        try {
            const response = await fetch('/upload/', { method: 'POST', body: formData });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
            }
            const result = await response.json();
            payload.file_url = result.file_url;
            payload.file_name = result.file_name;
            payload.file_type = result.file_type;
        } catch (err) {
            alert(err.message);
            return;
        }
    }

    if (message) {
        payload.message = message;
    }

    socket.send(JSON.stringify(payload));

    input.value = '';
    fileInput.value = '';
}

document.getElementById('chat-message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

window.addEventListener("beforeunload", () => {
    if (socket.readyState === WebSocket.OPEN) socket.close();
});
</script>
{% endblock %}