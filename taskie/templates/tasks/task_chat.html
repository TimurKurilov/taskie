{% extends "base.html" %}
{% load static %}

{% block title %}Чат{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task_chat.css' %}">
{% endblock %}

{% block content %}
<h2>Чат задачи</h2>

<div id="chat-log" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px;">
  {% if messages %}
    {% for message in messages %}
      <div>
        <strong>{{ message.user.username }}:</strong> {{ message.context }}
        {% if message.file_url %}
          {% if message.file_type == 'image' %}
            <img src="{{ message.file_url }}" alt="{{ message.file_name }}" style="max-width:200px; border-radius:8px; margin-top:5px;"/>
          {% elif message.file_type == 'video' %}
            <video controls width="200" style="border-radius:8px; margin-top:5px;">
              <source src="{{ message.file_url }}" type="video/mp4">
            </video>
          {% elif message.file_type == 'audio' %}
            <audio controls style="width:100%; margin-top:5px;">
              <source src="{{ message.file_url }}" type="audio/mpeg">
            </audio>
          {% else %}
            <p>File: <a href="{{ message.file_url }}" target="_blank" rel="noopener noreferrer">{{ message.file_name }}</a></p>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>Пока нет сообщений.</p>
  {% endif %}
</div>

<input id="chat-message-input" type="text" placeholder="Введите сообщение" autocomplete="off" />
<input id="file-input" type="file" />
<button onclick="sendMessage()">Отправить</button>

<script>
const chatLog = document.getElementById('chat-log');
const taskId = "{{ task_id }}";
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + '/ws/chat/' + taskId + '/');

function addMessage(username, message) {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${username}:</strong> ${message}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function displayUploadedFile(fileUrl, fileName, fileType, username) {
    const div = document.createElement('div');
    let contentHtml = '';

    if (fileType === 'image') {
        contentHtml = `<img src="${fileUrl}" alt="${fileName}" style="max-width:200px; border-radius:8px; margin-top:5px;">`;
    } else if (fileType === 'video') {
        contentHtml = `<video controls width="200" style="border-radius:8px; margin-top:5px;"><source src="${fileUrl}" type="video/mp4"></video>`;
    } else if (fileType === 'audio') {
        contentHtml = `<audio controls style="width:100%; margin-top:5px;"><source src="${fileUrl}" type="audio/mpeg"></audio>`;
    } else {
        contentHtml = `<p>File: <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">${fileName}</a></p>`;
    }

    div.innerHTML = `<strong>${username}:</strong> ${contentHtml}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

socket.onopen = () => console.log("WebSocket connected");

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.message && data.username) {
        addMessage(data.username, data.message);
    }

    if (data.file_url && data.file_name && data.file_type && data.username) {
        displayUploadedFile(data.file_url, data.file_name, data.file_type, data.username);
    }
};

socket.onclose = (event) => console.log("WebSocket closed:", event.code);

async function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('file-input');
    const message = input.value.trim();
    const file = fileInput.files[0];

    if (socket.readyState !== WebSocket.OPEN) {
        alert("Соединение ещё не установлено. Попробуйте чуть позже.");
        return;
    }

    if (!message && !file) {
        return;
    }

    let fileData = {};

    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('task_id', taskId);

        try {
            const response = await fetch('/upload/', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Ошибка загрузки файла!');
            const result = await response.json();
            fileData = {
                file_url: result.file_url,
                file_name: result.file_name,
                file_type: result.file_type
            };
        } catch (err) {
            alert(err.message);
            return;
        }
    }

    if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            message: message,
            ...fileData
        }));
        input.value = '';
        fileInput.value = '';
    }
}

window.addEventListener("beforeunload", () => {
    if (socket.readyState === WebSocket.OPEN) socket.close();
});
</script>
{% endblock %}
